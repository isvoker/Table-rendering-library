const proposals = (function () {
	"use strict";
	let options, container, page;

	function init() {
		container = document.getElementById("tableContainer");

		if (!container) {
			return;
		}

		let form = document.getElementById('filter-form');
		page = 1;
		Filter.init();

		options = {
			controllerParams: {
				controller: "proposals.d",
				action: "lk_proposals",
				category: form.dataset.category,
				filter: Filter.getValues(),
				page: page,
			},

			paramsForCreatTabl: {
				cellsCollection: cellsCollection,
				rowContainer: function () {
					return `<div class="styled-table__row flex">`;
				},
				btnLoadMore: true,
				container: container,
				clearTable: true,
			},
		};

		Filter.onApply((filterValues) => {
			options.controllerParams.page = 1;
			options.controllerParams.filter = filterValues;
			options.paramsForCreatTabl.clearTable = true;
			libraryRenderingForm.loadRows(options);
		});

		libraryRenderingForm.createStaticPartOfTable(options.paramsForCreatTabl);
		libraryRenderingForm.loadRows(options);
		addListeners();
	}

	function getSpreadsheet(type) {
		Sensei.xhr({
			data: {
				controller: "proposals.d",
				action: "getSpreadsheet",
				type: type,
				category: Filter.getDataCategory(),
				filter: Filter.getValues(),
			},
			onBeforeSend: () => {
				Filter.block();
			},
			onComplete: () => {
				Filter.unblock();
			},
			onSuccess: (response) => {
				if (response.download) {
					Sensei.download(response.download);
				}
			},
		});
	}

	function addListeners() {
		[...document.getElementsByClassName("js__export-to-spreadsheet")].forEach(
			(btn) => {
				btn.addEventListener("click", (evt) => {
					Sensei.ignoreEvent(evt);
					getSpreadsheet(btn.dataset.type);
				});
			}
		);
	}

	const cellsCollection = [
		{ title: "Учебный год", field: "contest", width: "10%" },
		{ title: "Статус", field: "status", width: "15%" },
		{ title: "Муниципальное образование", field: "joinProposalLocation", width: "20%",
			append: function (params) {
				return commonTableFunctions.joinProposalLocation(params);
			},
		},
		{ title: "Образовательная организация", field: "contender", width: "20%",
			append: function (params) {
				return `<div class="float-contacts js__float-contacts"
					data-position="right"
					data-target="Contender"
					data-id="${params.contender_id}">
					<span class="float-contacts__btn js__show-float-contacts">${params.contender}</span>
				</div>`;
			},
		},
		{ title: "Тип проекта", field: "type", width: "15%",
			append: function (params) {
				return params.type || "-";
			},
		},
		{ title: "Ответственный", field: "request_curator", width: "15%",
			append: function (params) {
				return params.request_curator
					? '<div class="float-contacts js__float-contacts"' +
						' data-position="left"' +
						' data-target="Staff"' +
						` data-id="${params.request_curator_id}">` +
						`<span class="float-contacts__btn js__show-float-contacts">${params.request_curator}</span>` +
						"</div>"
					: "-";
			},
		},
		{ title: "", field: "external-link", width: "6%",
			append: function (params) {
				return `<div class="styled-table__heading_item flex jc-c ai-c" style="height:100%">
					<a class="external-link" href="/lk/proposal_info/?id=${params.id}" title="Подробнее"></a>
				</div>`;
			},
		},
	];

	document.addEventListener("DOMContentLoaded", () => {
		init();
	});
})();
